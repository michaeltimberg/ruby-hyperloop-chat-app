<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />

    <title>
        Hyperloop Chat App
    </title>

    <!-- React and JQuery -->
    <script src="https://unpkg.com/react@15/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <!-- Opal and Hyperloop -->
    <script src="https://rawgit.com/ruby-hyperloop/hyperloop-js/master/opal-compiler.min.js"></script>
    <script src="https://rawgit.com/ruby-hyperloop/hyperloop-js/master/hyperloop.min.js"></script>

    <!-- We are going to add 3 external libraires needed for our sample ChatApp (Bootstrap and markedown) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
</head>

<body>
    <div data-hyperloop-mount="ChatApp"
         data-name="">
    </div>

    <script type="text/ruby">
        class ChatApp < Hyperloop::Component
            def render
                DIV do
                    Nav()

                    Messages()

                    InputBox()
                end
            end
        end

        class Nav < Hyperloop::Component
            param :login,
                type: Proc

            before_mount do
                mutate.current_user_name! nil

                mutate.user_name_input! ""
            end

            def render
                DIV do
                    INPUT(
                        type: :text,

                        value: state.user_name_input,

                        placeholder: "Enter your Handle"
                    ).on(:change) do |e|
                        mutate.user_name_input e.target.value
                    end

                    BUTTON(type: :button) {
                        "Login!"
                    }.on(:click) do
                        login!
                    end if valid_new_input?
                end
            end

            def valid_new_input?
                state.user_name_input.present? && state.user_name_input != state.current_user_name
            end

            def login!
                mutate.current_user_name state.user_name_input

                params.login(state.user_name_input)

                puts "*** #{ state.current_user_name } has logged in"
            end
        end

        class Messages < Hyperloop::Component
            def render
                # Eventually we will loop over and display each message
                # For now, we will just display one as an example

                Message()
            end
        end

        class Message < Hyperloop::Component
            def render
                FormattedDiv(markdown: "This **Markdown** will eventually be a message")
            end
        end

        class InputBox < Hyperloop::Component
            def render
                DIV do
                    "An input box to send new messages will".br
                    "go here plus a display of the formatted markdown".br

                    FormattedDiv(markdown: "This **Markdown** will get updated as the user types")
                end
            end
        end

        class FormattedDiv < Hyperloop::Component
            param :markdown,
                type: String

            def render
                DIV do
                    params.markdown
                end
            end
        end
    </script>
</body>
</html>
